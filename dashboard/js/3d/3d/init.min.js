var demo={LAZY_MIN:20,LAZY_MAX:100,CLEAR_COLOR:"",RES_PATH:"./js/plugins/3d/res",lastElement:null,timer:null,network:null,setNetwork:function(e){this.network=e},getNetwork:function(){return this.network},getRes:function(e){return demo.RES_PATH+"/"+e},getEnvMap:function(){if(!demo.defaultEnvmap){demo.defaultEnvmap=[];for(var e=demo.getRes("room.jpg"),t=0;t<6;t++)demo.defaultEnvmap.push(e)}return demo.defaultEnvmap},_creators:{},_filters:{},_shadowPainters:{},registerCreator:function(e,t){this._creators[e]=t},getCreator:function(e){return this._creators[e]},registerFilter:function(e,t){this._filters[e]=t},getFilter:function(e){return this._filters[e]},registerShadowPainter:function(e,t){this._shadowPainters[e]=t},getShadowPainter:function(e){return this._shadowPainters[e]},init:function(e,t,o,a,n,i){var r=window.network=new mono.Network3D;demo.typeFinder=new mono.QuickFinder(r.getDataBox(),"type","client"),demo.labelFinder=new mono.QuickFinder(r.getDataBox(),"label","client"),$("#"+e).html(""),r.setClearColor(0,0,0),r.setClearAlpha(0),setTimeout(function(){var t=$("#"+e).parent();console.log(t.width(),t.height()),r.adjustBounds($("#"+e).parent().width(),$("#"+e).parent().parent().height()-50)},20),$(window).resize(function(){r.adjustBounds($("#"+e).parent().width(),$("#"+e).parent().parent().height()-50)});var l=new mono.PerspectiveCamera(30,1.5,30,3e4);r.setCamera(l);var s=new mono.DefaultInteraction(r);s.yLowerLimitAngle=Math.PI/180*2,s.yUpLimitAngle=Math.PI/2,s.maxDistance=2e4,s.minDistance=50,s.zoomSpeed=3,s.panSpeed=.2;var m=new mono.EditInteraction(r);m.setShowHelpers(!0),m.setScaleable(!1),m.setRotateable(!1),m.setTranslateable(!0),r.setInteractions([s,new mono.SelectionInteraction(r),m]),r.isSelectable=function(e){return r.moveView&&"rack"===e.getClient("type")},r.editableFunction=function(e){return r.moveView&&"rack"===e.getClient("type")},document.getElementById(e).appendChild(r.getRootView()),o=o||0,a=a||0,i=i||new Tooltip(["设备名："],["000000"]),document.body.appendChild(i.getView()),r.getRootView().addEventListener("click",function(e){demo.handleClick(e,r,i)}),r.getRootView().addEventListener("dblclick",function(e){demo.handleDoubleClick(e,r)}),r.getRootView().addEventListener("mousemove",function(e){demo.handleMouseMove(e,r,i)}),demo.setupLights(r.getDataBox());var d=(new Date).getTime();demo.loadData(r,t);var g=(new Date).getTime();console.log("time:  "+(g-d)),demo.resetCamera(r,n)},resetCamera:function(e,t){e.getCamera().setPosition(t.w,t.h,t.d),e.getCamera().lookAt(new mono.Vec3(0,0,0))},dirtyShadowMap:function(e){var t=e.getDataBox().shadowHost,o=demo.typeFinder.findFirst("floorCombo");demo.updateShadowMap(o,t,t.getId(),e.getDataBox())},togglePersonVisible:function(e,t){var o=t.getCamera(),a=t.getDataBox();e?this.removeObj(a):this.loadObj(o,a)},removeObj:function(e){var t=demo.typeFinder.find("person").get(0);t.animate.stop(),e.removeByDescendant(t);var o=demo.typeFinder.find("trail").get(0);e.removeByDescendant(o)},_playRackDoorAnimate:function(e){var t=demo.labelFinder.findFirst(e),o=t.getChildren().get(0);o.getClient("animation")&&demo.playAnimation(o,o.getClient("animation"))},loadObj:function(e,t){},createPathAnimates:function(e,t,o,a,n,i){var r=[];if(o&&o.length>0){for(var l=t.getPositionX(),s=t.getPositionZ(),m=t.getRotationY(),d=function(e,t,o,a){if(o!=a&&NaN!=o){o-a>Math.PI&&(o-=2*Math.PI),o-a<-Math.PI&&(o+=2*Math.PI);var n=new twaver.Animate({from:a,to:o,type:"number",dur:300*Math.abs(o-a),easing:"easeNone",onPlay:function(){t.animate=this},onUpdate:function(e){t.setRotationY(e)}});return n.toAngle=o,n}},g=0;g<o.length;g++){var c=o[g],p=c[0],u=c[1],h=Math.atan2(-(u-s),p-l),f=d(e,t,h,m);f&&(r.push(f),m=f.toAngle);var w=new twaver.Animate({from:{x:l,y:s},to:{x:p,y:u},type:"point",dur:5*Math.sqrt((p-l)*(p-l)+(u-s)*(u-s)),easing:"easeNone",onPlay:function(){t.animate=this},onUpdate:function(e){t.setPositionX(e.x),t.setPositionZ(e.y)}});r.push(w),l=p,s=u}if(void 0!=n&&m!=n){var f=d(e,t,n,m);f&&r.push(f)}}r[r.length-1].onDone=i;for(var y,g=0;g<r.length;g++)g>0?(r[g-1].chain(r[g]),a&&g==r.length-1&&r[g].chain(y)):y=r[g];return y},toggleConnectionView:function(e){e.connectionView=!e.connectionView;var t=e.connectionView,o=e.getDataBox(),a=demo.typeFinder.find("connection"),n=demo.typeFinder.find("rail");a.forEach(function(e){if(e.setVisible(t),e.billboard||(e.billboard=new mono.Billboard,e.billboard.s({"m.texture.image":demo.createConnectionBillboardImage("0"),"m.vertical":!0}),e.billboard.setScale(60,30,1),e.billboard.setPosition(400,230,330),o.add(e.billboard)),e.billboard.setVisible(t),e.isVisible()){var a=new twaver.Animate({from:0,to:1,type:"number",dur:1e3,repeat:Number.POSITIVE_INFINITY,reverse:!1,onUpdate:function(t){if(e.s({"m.texture.offset":new mono.Vec2(t,0)}),1===t){var o="54"+parseInt(10*Math.random())+"."+parseInt(100*Math.random());e.billboard.s({"m.texture.image":demo.createConnectionBillboardImage(o)})}}});a.play(),e.offsetAnimate=a}else e.offsetAnimate&&e.offsetAnimate.stop()}),n.forEach(function(e){e.setVisible(t)})},setupLights:function(e){var t=new mono.PointLight(16711680,1.5);t.setPosition(100,100,100),e.add(t);var t=new mono.PointLight(65280,1.3);t.setPosition(-200,200,-200),e.add(t);var t=new mono.PointLight(16777215,.3);t.setPosition(1e3,-1e3,1e3),e.add(t),e.add(new mono.AmbientLight("white"))},handleClick:function(e,t,o){var a=t.getElementsByMouseEvent(e);if(a.length>0){var n=a[0],i=n.element,r=i.getClient("deviceType"),l=i.getClient("id"),s=o.getView();s.style.display="none",console.log(r+":"+i.getClient("name")),"lab"==r?1==i.getClient("validateLicense")&&window.open("#/"+r+"/"+l):"BEP"!=r&&"MTS"!=r&&"HPU"!=r||window.open("#/"+r+"/"+l)}},handleDoubleClick:function(e,t){var o=t.getCamera(),a=t.getDefaultInteraction(),n=demo.findFirstObjectByMouse(t,e);if(n){var i=n.element,r=n.point,l=o.getTarget();if(console.log(i.getClient("animation")),i.getClient("animation"))demo.playAnimation(i,i.getClient("animation"));else if(i.getClient("dbl.func")){var s=i.getClient("dbl.func");s()}else demo.animateCamera(o,a,l,r)}else{var l=o.getTarget(),r=new mono.Vec3(0,0,0);demo.animateCamera(o,a,l,r)}},handleMouseMove:function(e,t,o){var a=t.getElementsByMouseEvent(e),n=null,i=o.getView();if(a.length){var r=a[0],l=r.element;l.getClient("isTooltip")&&(n=l,3==o.keys.length?o.setValues([l.getClient("name"),l.getClient("status"),l.getClient("faultMsg")]):5==o.keys.length&&o.setValues([l.getClient("name"),l.getClient("status"),l.getClient("cycle"),l.getClient("progress"),l.getClient("faultMsg")]))}demo.lastElement!=n&&(clearTimeout(demo.timer),n&&(demo.timer=setTimeout(function(){i.style.display="block",i.style.position="absolute",i.style.left=window.lastEvent.pageX-i.clientWidth/2+"px",i.style.top=window.lastEvent.pageY-i.clientHeight-15+"px"},100))),demo.lastElement=n,null==n&&(i.style.display="none"),window.lastEvent=e},copyProperties:function(e,t,o){if(e&&t)for(var a in e)o&&o.indexOf(a)>=0||(t[a]=e[a])},createCubeObject:function(e){var t=e.translate||[0,0,0],o=e.width,a=e.height,n=e.depth,i=e.sideColor,r=e.topColor,l=new mono.Cube(o,a,n);return l.setPosition(t[0],t[1]+a/2,t[2]),l.s({"m.color":i,"m.ambient":i,"top.m.color":r,"top.m.ambient":r,"bottom.m.color":r,"bottom.m.ambient":r}),l.setClient("type","rack"),l},create2DPath:function(e){for(var t,o=0;o<e.length;o++){var a=e[o];t?t.lineTo(a[0],a[1],0):(t=new mono.Path,t.moveTo(a[0],a[1],0))}return t},create3DPath:function(e){for(var t,o=0;o<e.length;o++){var a=e[o];t?t.lineTo(a[0],a[1],a[2]):(t=new mono.Path,t.moveTo(a[0],a[1],a[2]))}return t},createPathObject:function(e){var t=e.translate||[0,0,0],o=e.width,a=e.height,n=e.data,i=this.create2DPath(n),r=e.insideColor,l=e.outsideColor,s=e.topColor,m=this.createWall(i,o,a,r,l,s);return m.setPosition(t[0],t[1],-t[2]),m.shadow=e.shadow,m},filterJson:function(e,t){for(var o=[],a=0;a<t.length;a++){var n=t[a],i=n.type,r=this.getFilter(i);if(r){var l=r(e,n);l&&(l instanceof Array?o=o.concat(l):(this.copyProperties(n,l,["type"]),o.push(l)))}else o.push(n)}return o},createCombo:function(e){for(var t=[],o=[],a=[],n=0;n<e.length;n++){var i=e[n],r=i.op||"+",l=i.style,s=(i.translate||[0,0,0],i.rotate||[0,0,0]),m=null;"path"===i.type&&(m=this.createPathObject(i)),"cube"===i.type&&(m=this.createCubeObject(i)),m&&(m.setRotation(s[0],s[1],s[2]),l&&m.s(l),t.push(m),t.length>1&&o.push(r),a.push(m.getId()))}if(t.length>0){var d=new mono.ComboNode(t,o);return d.setNames(a),d}return null},loadData:function(e,t){for(var o,a,n=demo.filterJson(e.getDataBox(),t.objects),i=e.getDataBox(),r=[],l=[],s=[],m=0;m<n.length;m++){var d=n[m],g=d.op,c=d.style,p=d.client,u=(d.translate||[0,0,0],d.rotate||[0,0,0]),h=null;"path"===d.type&&(h=this.createPathObject(d)),"cube"===d.type&&(h=this.createCubeObject(d)),d.shadowHost&&(o=h,a=h.getId(),i.shadowHost=o);var f=demo.getCreator(d.type);if(f)f(i,d);else if(h){if(h.shadow=d.shadow,h.setRotation(u[0],u[1],u[2]),c&&h.s(c),p)for(var w in p)h.setClient(w,p[w]);g?(r.push(h),r.length>1&&l.push(g),s.push(h.getId())):i.add(h)}}if(r.length>0){var y=new mono.ComboNode(r,l);y.setNames(s),y.setClient("type","floorCombo"),i.add(y),o&&a&&setTimeout(function(){demo.updateShadowMap(y,o,a,i)},demo.LAZY_MAX)}},updateShadowMap:function(e,t,o,a){var n=demo.createShadowImage(a,t.getWidth(),t.getDepth()),i=o+"-top.m.lightmap.image";e.setStyle(i,n)},loadRackContent:function(e,t,o,a,n,i,r,l,s,m,d,g,c){for(var p=10,u=2,h=!1;p<i-20;){var f=parseInt(3*Math.random())+1,w="server"+f+".jpg";3===f&&(w="server3.png");var y=(3===f||p>100)&&!h&&l?l.color:null,v=this.createServer(e,s,m,w,y,c),b=v.getBoundingBox().size();if(y&&(h=!0),v.setPositionY(p+b.y/2-i/2),v.setPositionZ(v.getPositionZ()+5),v.setParent(g),p=p+b.y+u,p>200){e.removeByDescendant(v,!0);break}}},createServer:function(e,t,o,a,n,i){var r={"server1.jpg":8.89,"server2.jpg":13.335,"server3.png":26.67},l=(t.getPositionX(),t.getPositionZ(),o.getWidth()),s=r[a],m=o.getDepth(),d=new mono.Cube(l-2,s-2,m-4),g=n?n:"#5B6976";d.s({"m.color":g,"m.ambient":g,"m.type":"phong","m.texture.image":demo.getRes("rack_inside.jpg")}),d.setPosition(0,.5,(t.getDepth()-d.getDepth())/2);var c=new mono.Cube(l+2,s+1,.5);if(n=n?n:"#FFFFFF",c.s({"m.texture.image":demo.getRes("rack_inside.jpg"),"front.m.texture.image":demo.RES_PATH+"/"+a,"front.m.texture.repeat":new mono.Vec2(1,1),"m.specularStrength":100,"m.transparent":!0,"m.color":n,"m.ambient":n}),c.setPosition(0,0,d.getDepth()/2+(t.getDepth()-d.getDepth())/2),"server3.png"==a){var p="#FFFFFF";c.s({"m.color":p,"m.ambient":p})}var u=new mono.ComboNode([d,c],["+"]);if(u.setClient("animation","pullOut.z"),u.setPosition(.5,0,-5),e.add(u),"server3.png"==a)for(var h=!1,f=2.1008,w=.9897,l=l+2,s=s+1,y=(l-2*f)/14,v=14,b=0;b<v;b++){var x="#FFFFFF";b>5&&!h&&(x=n,h=!0);var C={height:s-2*w,width:y,depth:.4*m,pic:demo.RES_PATH+"/card"+(b%4+1)+".png",color:x},P=demo.createCard(C);e.add(P),P.setParent(u),P.setClient("type","card"),P.setClient("BID","card-"+b),P.setClient("isAlarm","#FFFFFF"!=x),P.p(-l/2+f+(b+.5)*y,-s/2+w,c.getPositionZ()-1),P.setClient("animation","pullOut.z"),P.getClient("isAlarm")&&(i.alarmCard=P)}return u},createCard:function(e){var t=e.translate||[0,0,0],o=t[0],a=t[1],n=t[2],i=e.width||10,r=e.height||50,l=e.depth||50,s=e.rotate||[0,0,0],m=e.color||"white",d=e.pic||demo.getRes("card1.png"),g=[{type:"cube",width:i,height:r,depth:1,translate:[o,a,n+1],rotate:s,op:"+",style:{"m.color":m,"m.ambient":m,"m.texture.image":demo.getRes("gray.png"),"front.m.texture.image":d,"back.m.texture.image":d}},{type:"cube",width:1,height:.95*r,depth:l,translate:[o,a,n-l/2+1],rotate:s,op:"+",style:{"m.color":m,"m.ambient":m,"m.texture.image":demo.getRes("gray.png"),"left.m.texture.image":demo.getRes("card_body.png"),"right.m.texture.image":demo.getRes("card_body.png"),"left.m.texture.flipX":!0,"m.transparent":!0,"m.lightmap.image":demo.getRes("outside_lightmap.jpg")}}];return demo.createCombo(g)},createShadowImage:function(e,t,o){var a=document.createElement("canvas");a.width=t,a.height=o;var n=a.getContext("2d");n.beginPath(),n.rect(0,0,t,o),n.fillStyle="white",n.fill();return e.forEach(function(e){if(e instanceof mono.Entity&&e.shadow){var a=e.getPosition()||{x:0,y:0,z:0},i=e.getRotation()||{x:0,y:0,z:0},i=-i[1];demo.paintShadow(e,n,t,o,a,i)}}),a},paintShadow:function(e,t,o,a,n,i){var r=e.getClient("type"),l=demo.getShadowPainter(r);l&&l(e,t,o,a,n,i)},findFirstObjectByMouse:function(e,t){var o=e.getElementsByMouseEvent(t);if(o.length)for(var a=0;a<o.length;a++){var n=o[a],i=n.element;if(!(i instanceof mono.Billboard))return n}return null},animateCamera:function(e,t,o,a,n){var i=e.getPosition().sub(e.getTarget()),r=new twaver.Animate({from:0,to:1,dur:500,easing:"easeBoth",onUpdate:function(n){var r=o.x+(a.x-o.x)*n,l=o.y+(a.y-o.y)*n,s=o.z+(a.z-o.z)*n,m=new mono.Vec3(r,l,s);e.lookAt(m),t.target=m;var d=(new mono.Vec3).addVectors(i,m);e.setPosition(d)}});r.onDone=n,r.play()},playAnimation:function(e,t,o){var a=t.split(".");if("pullOut"===a[0]){var n=a[1];demo.animatePullOut(e,n,o)}if("rotate"===a[0]){var i=a[1],r=a[2],l=a[3];demo.animateRotate(e,i,r,l,o)}},animatePullOut:function(e,t,o){var a=e.getBoundingBox().size().multiply(e.getScale()),n=.8,i=new mono.Vec3(0,0,1),r=0;"x"===t&&(i=new mono.Vec3(1,0,0),r=a.x),"-x"===t&&(i=new mono.Vec3((-1),0,0),r=a.x),"y"===t&&(i=new mono.Vec3(0,1,0),r=a.y),"-y"===t&&(i=new mono.Vec3(0,(-1),0),r=a.y),"z"===t&&(i=new mono.Vec3(0,0,1),r=a.z),"-z"===t&&(i=new mono.Vec3(0,0,(-1)),r=a.z),r*=n,e.getClient("animated")&&(i=i.negate());var l=e.getPosition().clone();e.setClient("animated",!e.getClient("animated")),new twaver.Animate({from:0,to:1,dur:2e3,easing:"bounceOut",onUpdate:function(t){e.setPosition(l.clone().add(i.clone().multiplyScalar(r*t)))},onDone:function(){demo.animationFinished(e),o&&o()}}).play()},animateRotate:function(e,t,o,a,n){a=a||"easeInStrong";var i=e.getBoundingBox().size().multiply(e.getScale()),r=0,l=1;e.getClient("animated")&&(l=-1),e.setClient("animated",!e.getClient("animated"));var s,m;if("left"===t){s=new mono.Vec3(-i.x/2,0,0);var m=new mono.Vec3(0,1,0)}if("right"===t){s=new mono.Vec3(i.x/2,0,0);var m=new mono.Vec3(0,1,0)}var d=new twaver.Animate({from:r,to:l,dur:1500,easing:a,onUpdate:function(t){void 0===this.lastValue&&(this.lastValue=0),e.rotateFromAxis(m.clone(),s.clone(),Math.PI/180*o*(t-this.lastValue)),this.lastValue=t},onDone:function(){delete this.lastValue,demo.animationFinished(e),n&&n()}});d.play()},animationFinished:function(e){var t=e.getClient("animation.done.func");t&&t()},getRandomInt:function(e){return parseInt(Math.random()*e)},getRandomLazyTime:function(){var e=demo.LAZY_MAX-demo.LAZY_MIN;return demo.getRandomInt(e)+demo.LAZY_MIN},generateAssetImage:function(e){var t=512,o=256,a=document.createElement("canvas");a.width=t,a.height=o;var n=a.getContext("2d");return n.fillStyle="white",n.fillRect(0,0,t,o),n.font='150px "Microsoft Yahei" ',n.fillStyle="black",n.textAlign="center",n.textBaseline="middle",n.fillText(e,t/2,o/2),n.strokeStyle="black",n.lineWidth=15,n.strokeText(e,t/2,o/2),a},toggleTemperatureView:function(e){e.temperatureView=!e.temperatureView,e.getDataBox().forEach(function(t){var o=t.getClient("type");if(("rack"===o||"rack.door"===o)&&(t.setVisible(!e.temperatureView),"rack"===o)){if(!t.temperatureFake){var a=new mono.Cube(t.getWidth(),t.getHeight(),t.getDepth());t.temperatureFake=a;var n=demo.createSideTemperatureImage(t,3+10*Math.random());a.s({"m.texture.image":n,"top.m.texture.image":t.getStyle("top.m.texture.image"),"top.m.normalmap.image":demo.getRes("metal_normalmap.jpg"),"top.m.specularmap.image":t.getStyle("top.m.texture.image"),"top.m.envmap.image":demo.getEnvMap(),"top.m.type":"phong"}),e.getDataBox().add(a)}t.temperatureFake.setPosition(t.getPosition()),t.temperatureFake.setVisible(e.temperatureView)}}),e.temperatureView?(demo.createTemperatureBoard(e.getDataBox()),demo.createTemperatureWall(e.getDataBox())):(e.getDataBox().remove(e.getDataBox().temperaturePlane),delete e.getDataBox().temperaturePlane,e.getDataBox().remove(e.getDataBox().temperatureWall),delete e.getDataBox().temperatureWall)},createTemperatureBoard:function(e){var t=e.shadowHost,o=new TemperatureBoard(512,512,"h",20);e.forEach(function(e){var a=e.getClient("type");if("rack"===a){var n=e.getPositionX()/t.getWidth()*512+256,i=e.getPositionZ()/t.getDepth()*512+256,r=.1+.3*Math.random(),l=e.getWidth()/t.getWidth()*512,s=e.getDepth()/t.getWidth()*512;o.addPoint(n-l/2,i+s/2,r),o.addPoint(n+l/2,i+s/2,r),o.addPoint(n-l/2,i-s/2,r),o.addPoint(n+l/2,i-s/2,r),o.addPoint(n,i,r)}});var a=o.getImage(),n=new mono.Plane(t.getWidth(),t.getDepth());n.s({"m.texture.image":a,"m.transparent":!0,"m.side":mono.DoubleSide,"m.type":"phong"}),n.setPositionY(10),n.setRotationX(-Math.PI/2),e.add(n),e.temperaturePlane=n},createTemperatureWall:function(e){var t=new mono.Cube(990,200,10);t.s({"m.visible":!1}),t.s({"front.m.visible":!0,"m.texture.image":demo.getRes("temp1.jpg"),"m.side":mono.DoubleSide,"m.type":"phong"}),t.setPosition(0,t.getHeight()/2,400),t.setRotationX(Math.PI),e.add(t),e.temperatureWall=t},createSideTemperatureImage:function(e,t){for(var o=2,a=e.getHeight(),n=a/t,i=new TemperatureBoard(o,a,"v",a/t),r=0;r<t;r++){var l=.3+.2*Math.random();l<4&&(l=.9*Math.random()),i.addPoint(o/2,n*r,l)}return i.getImage()},toggleSpaceView:function(e){e.spaceView=!e.spaceView,e.getDataBox().forEach(function(t){var o=t.getClient("type");if(("rack"===o||"rack.door"===o)&&(t.setVisible(!e.spaceView),"rack"===o)){t.spaceCubes||(t.spaceCubes=demo.createRackSpaceCubes(e.getDataBox(),t));for(var a=0;a<t.spaceCubes.length;a++)t.spaceCubes[a].setPosition(t.getPositionX(),t.spaceCubes[a].getPositionY(),t.getPositionZ()),t.spaceCubes[a].setVisible(e.spaceView)}})},createRackSpaceCubes:function(e,t){for(var o=[],a=t.getWidth(),n=t.getHeight(),i=t.getDepth(),r=42,l=n/r,s=0,m=["#8A0808","#088A08","#088A85","#6A0888","#B18904"],d=!1;s<42;){var g=parseInt(1+5*Math.random());d=!d;var c=d?m[g-1]:"#A4A4A4";g*=d?2:4,s+g>r&&(g=r-s);var p=new mono.Cube(a,l*g-2,i),u=(s+g/2)*l;p.setPosition(t.getPositionX(),u,t.getPositionZ()),p.s({"m.type":"phong","m.color":c,"m.ambient":c,"m.specularStrength":50}),d&&p.s({"m.transparent":!0,"m.opacity":.6}),e.add(p),o.push(p),s+=g}return o},toggleUsageView:function(e){e.usageView=!e.usageView,e.getDataBox().forEach(function(t){var o=t.getClient("type");if(("rack"===o||"rack.door"===o)&&(t.setVisible(!e.usageView),"rack"===o)){if(!t.usageFakeTotal){var a=Math.random(),n=demo.getHSVColor(.7*(1-a),.7,.7),i=new mono.Cube(t.getWidth(),t.getHeight(),t.getDepth());t.usageFakeTotal=i,i.s({"m.wireframe":!0,"m.transparent":!0,"m.opacity":.2}),i.setPosition(t.getPosition()),e.getDataBox().add(i);var r=t.getHeight()*a,l=new mono.Cube(t.getWidth(),0,t.getDepth());t.usageFakeUsed=l,l.s({"m.type":"phong","m.color":n,"m.ambient":n,"m.specularStrength":20,"left.m.lightmap.image":demo.getRes("inside_lightmap.jpg"),"right.m.lightmap.image":demo.getRes("inside_lightmap.jpg"),"back.m.lightmap.image":demo.getRes("inside_lightmap.jpg"),"front.m.lightmap.image":demo.getRes("inside_lightmap.jpg")}),l.setPosition(t.getPosition()),l.setPositionY(0),e.getDataBox().add(l);var s=new twaver.Animate({from:0,to:r,type:"number",dur:2e3,delay:200*Math.random(),easing:"bounceOut",onUpdate:function(e){l.setHeight(e),l.setPositionY(l.getHeight()/2)}});t.usageAnimation=s}t.usageFakeTotal.setVisible(e.usageView),t.usageFakeUsed.setVisible(e.usageView),t.usageFakeTotal.setPosition(t.getPosition().clone()),t.usageFakeUsed.setHeight(0),t.usageFakeUsed.setPosition(t.getPosition().clone()),t.usageFakeUsed.setPositionY(0),e.usageView?t.usageAnimation.play():t.usageAnimation.stop()}})},toggleAirView:function(e){e.airView=!e.airView,e.getDataBox().airPlanes||(e.getDataBox().airPlanes=demo.createAirPlanes());for(var t=0;t<e.getDataBox().airPlanes.length;t++){var o=e.getDataBox().airPlanes[t];e.airView?(e.getDataBox().add(o),o.airAnimation.play()):(e.getDataBox().remove(o),o.airAnimation.stop())}},toggleMoveView:function(e){e.getDataBox().getSelectionModel().clearSelection(),e.moveView=!e.moveView,e.dirtyNetwork()},getHSVColor:function(e,t,o){var a,n,i,r,l,s,m,d;switch(e&&void 0===t&&void 0===o&&(t=e.s,o=e.v,e=e.h),r=Math.floor(6*e),l=6*e-r,s=o*(1-t),m=o*(1-l*t),d=o*(1-(1-l)*t),r%6){case 0:a=o,n=d,i=s;break;case 1:a=m,n=o,i=s;break;case 2:a=s,n=o,i=d;break;case 3:a=s,n=m,i=o;break;case 4:a=d,n=s,i=o;break;case 5:a=o,n=s,i=m}var g="#"+this.toHex(255*a)+this.toHex(255*n)+this.toHex(255*i);return g},toHex:function(e){var t=parseInt(e).toString(16);return 1==t.length&&(t="0"+t),t},showDialog:function(e,t,o,a){t=t||"",o=o||600,a=a||400;var n=document.getElementById("dialog");n&&document.body.removeChild(n),n=document.createElement("div"),n.setAttribute("id","dialog"),n.style.display="block",n.style.position="absolute",n.style.left="100px",n.style.top="100px",n.style.width=o+"px",n.style.height=a+"px",n.style.background="rgba(164,186,223,0.75)",n.style["border-radius"]="5px",document.body.appendChild(n);var i=document.createElement("span");i.style.display="block",i.style.color="white",i.style["font-size"]="13px",i.style.position="absolute",i.style.left="10px",i.style.top="2px",i.innerHTML=t,n.appendChild(i);var r=document.createElement("img");r.style.position="absolute",r.style.right="4px",r.style.top="4px",r.setAttribute("src",demo.getRes("close.png")),r.onclick=function(){document.body.removeChild(n)},n.appendChild(r),e&&(e.style.display="block",e.style.position="absolute",e.style.left="3px",e.style.top="24px",e.style.width=o-6+"px",e.style.height=a-26+"px",n.appendChild(e))},showVideoDialog:function(e){var t=document.createElement("video");t.setAttribute("src",demo.getRes("test.mp4")),t.setAttribute("controls","true"),t.setAttribute("autoplay","true"),demo.showDialog(t,e,610,280)},createConnectionBillboardImage:function(e){var t=512,o=256,a="当前网络流量",n=document.createElement("canvas");n.width=t,n.height=o;var i=n.getContext("2d");i.fillStyle="#FE642E",i.fillRect(0,0,t,o-o/6),i.beginPath(),i.moveTo(.2*t,0),i.lineTo(t/2,o),i.lineTo(.8*t,0),i.fill();var r="white";i.font='40px "Microsoft Yahei" ',i.fillStyle=r,i.textAlign="left",i.textBaseline="middle",i.fillText(a,o/10,o/5);var r="white";return a=e,i.font='100px "Microsoft Yahei" ',i.fillStyle=r,i.textAlign="left",i.textBaseline="middle",i.fillText(a,o/10,o/2),i.strokeStyle=r,i.lineWidth=4,i.strokeText(a,o/10,o/2),a="Mb/s",i.font='50px "Microsoft Yahei" ',i.fillStyle=r,i.textAlign="right",i.textBaseline="middle",i.fillText(a,t-o/10,o/2+20),n},inspection:function(e){var t,o,a;e.getDataBox().forEach(function(e){"left-door"===e.getClient("type")&&(t=e),"right-door"===e.getClient("type")&&(o=e),"1A04"===e.getClient("label")&&(a=e)});var n=[{px:2e3,py:500,pz:2e3,tx:0,ty:0,tz:0},{px:2e3,pz:-2e3},{px:0,pz:-2500},{px:-2e3},{px:-2500,pz:0},{pz:2e3},{px:-1200,tx:-350,ty:170,tz:500},{px:-550,py:190,pz:1100}],i=[{px:-350,py:120,pz:600,tx:-340,ty:150,tz:-300},{py:100,pz:200},{px:-300,py:300,pz:150,ty:70}],r=function(t){var o=t.alarmCard,a=o.getWorldPosition(),n=[{px:a.x,py:a.y,pz:a.z+120,tx:a.x,ty:a.y+10,tz:a.z},{px:a.x-30,py:a.y+30,pz:a.z+90,ty:a.y+15}];mono.AniUtil.playInspection(e,n,function(){demo.playAnimation(o,o.getClient("animation"),function(){e.inspecting=!1,demo.showAlarmDialog()})})};a.setClient("loaded.func",r);var l=function(){demo.playAnimation(t,t.getClient("animation"),function(){mono.AniUtil.playInspection(e,i,function(){var e=a.door;demo.playAnimation(e,e.getClient("animation"))})}),demo.playAnimation(o,o.getClient("animation"))};mono.AniUtil.playInspection(e,n,l)},showAlarmDialog:function(){var e=document.createElement("span");e.style["background-color"]="rgba(255,255,255,0.85)",e.style.padding="10px",e.style.color="darkslategrey",e.innerHTML="<b>告警描述</b><p>中兴S330板卡有EPE1，LP1，OL16，CSB,SC，EPE1（2M电口）与LP1（155M光）与用户路由器连接。EPE1上发生TU-AIS ,TU-LOP，UNEQ，误码秒告警，所配业务均出现，用户路由器上出现频繁up，down告警。用户路由器上与1块LP1（有vc12级别的交叉）连接的cpos板卡上也有频繁up，down告警，与另一块LP1（vc4穿通）连接的cpos卡上无告警</p><b>故障分析</b><p>情况很多。如果只是单站出现，首先判断所属环上保护，主用光路有没有告警；如果有，解决主用线路问题；如果没有，做交叉板主备切换--当然是在晚上进行；很少出现主备交叉板都坏的情况。还没解决的话，依次检查单板和接口板。</p>",demo.showDialog(e,"SDH 2M支路板告警",510,250),e.style.width="484px",e.style.height="203px"},toggleLinkVisible:function(e){},resetView:function(e){demo.resetCamera(e);var t=[];e.getDataBox().forEach(function(e){"rack"===e.getClient("type")&&e.oldRack&&t.push(e)});for(var o=0;o<t.length;o++){var a=t[o],n=a.oldRack;a.alarm&&e.getDataBox().getAlarmBox().remove(a.alarm),e.getDataBox().removeByDescendant(a,!0),e.getDataBox().add(n),n.alarm&&e.getDataBox().getAlarmBox().add(n.alarm),n.door.setParent(n),n.setClient("loaded",!1);var i=n.door;e.getDataBox().add(i),i.getClient("animated")&&demo.playAnimation(i,i.getClient("animation"))}var r=[];e.getDataBox().forEach(function(e){"left-door"!==e.getClient("type")&&"right-door"!==e.getClient("type")||r.push(e)});for(var o=0;o<r.length;o++){var i=r[o];i.getClient("animated")&&demo.playAnimation(i,i.getClient("animation"))}e.temperatureView&&demo.toggleTemperatureView(e),e.spaceView&&demo.toggleSpaceView(e),e.usageView&&demo.toggleUsageView(e),e.airView&&demo.toggleAirView(e),e.moveView&&demo.toggleMoveView(e),e.connectionView&&demo.toggleConnectionView(e),e.smokeView&&demo.toggleSmokeView(e),e.waterView&&demo.toggleWaterView(e),e.laserView&&demo.toggleLaserView(e),e.powerView&&demo.togglePowerView(e)},resetRackPosition:function(e){e.getDataBox().forEach(function(e){"rack"===e.getClient("type")&&e.setPosition(e.getClient("origin"))}),demo.dirtyShadowMap(e)},showDoorTable:function(){},toggleSmokeView:function(e){e.smokeView=!e.smokeView,e.getDataBox().forEach(function(t){var o=t.getClient("type");"smoke"!==o&&"extinguisher_arrow"!==o||t.setVisible(e.smokeView)})},startSmokeAnimation:function(e){setInterval(demo.updateSmoke(e),200)},startFpsAnimation:function(e){var t=document.createElement("span");t.style.display="block",t.style.color="white",t.style["font-size"]="10px",t.style.position="absolute",t.style.left="10px",t.style.top="10px",t.style.visibility="hidden",document.body.appendChild(t),e.fpsDiv=t,demo.fps=0,e.setRenderCallback(function(){demo.fps++}),setInterval(demo.updateFps(e),1e3)},toggleFpsView:function(e){e.fpsView=!e.fpsView,e.fpsView?e.fpsDiv.style.visibility="inherit":e.fpsDiv.style.visibility="hidden"},updateSmoke:function(e){return function(){e.smokeView&&e.getDataBox().forEach(function(t){if("smoke"===t.getClient("type")&&t.isVisible()){for(var o=t,a=o.vertices.length,n=0;n<a;n++){var i=o.vertices[n];i.y=200*Math.random(),i.x=Math.random()*i.y/2-i.y/4,i.z=Math.random()*i.y/2-i.y/4}o.verticesNeedUpdate=!0,e.dirtyNetwork()}})}},updateFps:function(e){return function(){e.fpsDiv.innerHTML="FPS:  "+demo.fps,demo.fps=0}},toggleWaterView:function(e){if(e.waterView=!e.waterView,e.waterView)demo.createWaterLeaking(e.getDataBox()),e.getDataBox().oldAlarms=e.getDataBox().getAlarmBox().toDatas(),e.getDataBox().getAlarmBox().clear();else{if(e.getDataBox().waterLeakingObjects)for(var t=0;t<e.getDataBox().waterLeakingObjects.length;t++)e.getDataBox().remove(e.getDataBox().waterLeakingObjects[t]);e.getDataBox().oldAlarms.forEach(function(t){e.getDataBox().getAlarmBox().add(t)})}e.getDataBox().forEach(function(t){var o=t.getClient("type");"water_cable"===o?t.setVisible(e.waterView):o&&"floorCombo"!==o&&"extinguisher"!==o&&"glassWall"!==o&&(e.waterView?"rack"===o||"rack_door"===o?(t.oldTransparent=t.getStyle("m.transparent"),t.oldOpacity=t.getStyle("m.opacity"),t.setStyle("m.transparent",!0),t.setStyle("m.opacity",.1)):(t.oldVisible=t.isVisible(),t.setVisible(!1)):"rack"===o||"rack_door"===o?(t.setStyle("m.transparent",t.oldTransparent),t.setStyle("m.opacity",t.oldOpacity)):t.setVisible(t.oldVisible))})},createWaterLeaking:function(e){var t=new mono.Billboard;t.s({"m.texture.image":demo.getRes("alert.png"),"m.vertical":!0}),t.setScale(80,160,1),t.setPosition(50,90,50),e.add(t);var o=new mono.Sphere(30);o.s({"m.transparent":!0,"m.opacity":.8,"m.type":"phong","m.color":"#58FAD0","m.ambient":"#81BEF7","m.specularStrength":50,"m.normalmap.image":demo.getRes("rack_inside_normal.jpg")}),o.setPosition(50,0,50),o.setScale(1,.1,.7),e.add(o),e.waterLeakingObjects=[t,o]},toggleLaserView:function(e){e.laserView=!e.laserView,e.getDataBox().forEach(function(t){"laser"===t.getClient("type")&&t.setVisible(e.laserView)})},setupControlBar:function(e){var t=document.createElement("div");t.setAttribute("id","toolbar"),t.style.display="block",t.style.position="absolute",t.style.left="20px",t.style.top="10px",t.style.width="auto",document.body.appendChild(t)},setupToolbar:function(e){var t=e.length,o=32,a=document.createElement("div");a.setAttribute("id","toolbar"),a.style.display="block",a.style.position="absolute",a.style.left="10px",a.style.top="75px",a.style.width="32px",a.style.height=t*o+o+"px",a.style.background="rgba(255,255,255,0.75)",a.style["border-radius"]="5px",document.body.appendChild(a);for(var n=0;n<t;n++){var i=e[n],r=i.icon,l=document.createElement("img");l.style.position="absolute",l.style.left="4px",l.style.top=o/2+n*o+"px",l.style["pointer-events"]="auto",l.style.cursor="pointer",l.setAttribute("src",demo.getRes(r)),l.style.width="24px",l.style.height="24px",l.setAttribute("title",i.label),l.onclick=i.clickFunction,a.appendChild(l)}},togglePowerView:function(e){e.powerLineCreated||demo.createPowerLines(e),e.powerView=!e.powerView,e.getDataBox().forEach(function(t){var o=t.getClient("type");"power_line"===o&&t.setVisible(e.powerView)})},createPowerLines:function(e){var t=e.getDataBox(),o=function(e,o){t.forEach(function(a){if("rack"===a.getClient("type")){var n=a.getClient("label");if(e.indexOf(n)>-1){var i=a.getPosition(),r=[];r.push([i.x,i.y,i.z]),r.push([i.x,i.y,i.z-60]),r.push([i.x,240,i.z-60]),r.push([i.x,240,o]),r.push([-550,240,o]),demo.createPathLink(t,r,"#FE9A2E","power_line");var r=[];r.push([i.x-5,i.y,i.z]),r.push([i.x-5,i.y,i.z-60]),r.push([i.x-5,250,i.z-60]),r.push([i.x-5,250,o]),r.push([-550,250,o]),demo.createPathLink(t,r,"cyan","power_line"),o-=5}}})};o(["1A07","1A08","1A09","1A10","1A11","1A12","1A13"],150),o(["1A00","1A01","1A02"],160),o(["1A03","1A04","1A05","1A06"],-300),demo.createPathLink(t,[[-1e3,420,600],[-800,250,500],[-550,250,500],[-550,250,-315]],"cyan","power_line"),demo.createPathLink(t,[[-1e3,410,600],[-800,240,500],[-550,240,500],[-550,240,-315]],"#FE9A2E","power_line")},createPathLink:function(e,t,o,a){if(t&&t.length>1){o=o||"white";for(var n=1;n<t.length;n++){var i=t[n-1],r=t[n],l=new mono.Cube(.001,.001,.001);l.s({"m.color":o}),l.setPosition(i[0],i[1],i[2]),l.setClient("type",a),e.add(l);var s=l.clone();s.setPosition(r[0],r[1],r[2]),s.setClient("type",a),e.add(s);var m=new mono.Link(l,s);m.s({"m.color":o}),m.setClient("type",a),e.add(m)}}}};eval(function(e,t,o,a,n,i){if(n=function(e){return(e<t?"":n(parseInt(e/t)))+((e%=t)>35?String.fromCharCode(e+29):e.toString(36))},!"".replace(/^/,String)){for(;o--;)i[n(o)]=a[o]||n(o);a=[function(e){return i[e]}],n=function(){return"\\w+"},o=1}for(;o--;)a[o]&&(e=e.replace(new RegExp("\\b"+n(o)+"\\b","g"),a[o]));return e}('5.p("A",6(b,a){o{4:"n",l:h,k:10,j:h,i:[0,-10,0],K:!0,M:"+",y:{"m.4":"B","m.9":"#g","m.L":"#g","1.m.4":"N","1.m.O.q":r s.t(10,10),"1.m.9":"#u","1.m.v":!0,"1.m.w":3,"1.m.17":3}}});5.p("7",6(b,a){o{4:"n",l:8,k:8,j:8,D:!0,E:"#F",G:"#H",I:{4:"7"}}});5.J("7",6(b,a,d,e,c,f){d=d/2+c.x;e=e/2+c.z;c=b.P();b=b.Q();a.R();a.i(d,e);a.S(f);a.T();a.U(-c/2,0);a.V(c/2,0);a.W=b;a.X="#Y";a.Z="#11";a.12=13;a.14=0;a.15=0;a.16();a.C()});',62,70,"|top|||type|demo|function|floor_box|100|color|||||||626262|1E3|translate|depth|height|width||cube|return|registerFilter|repeat|new|mono|Vec2|898989|polygonOffset|polygonOffsetFactor||style||floor|phong|restore|shadow|sideColor|3b3a3a|topColor|a4a4a4|client|registerShadowPainter|shadowHost|ambient|op|basic|texture|getWidth|getDepth|save|rotate|beginPath|moveTo|lineTo|lineWidth|strokeStyle|DDDDDD|shadowColor||BBBBBB|shadowBlur|50|shadowOffsetX|shadowOffsetY|stroke|polygonOffsetUnits".split("|"),0,{}));