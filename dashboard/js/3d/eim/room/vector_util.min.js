var drawImage=function(e,t,r,a,n,o,l){var i,c,u,_,g=1;"object"!=typeof t&&(c=t,i=_twaver.images[t],t=i&&i.getImage()),isImage(t)?e.drawImage(i?i.getImage(r):t,Math.round(a.x),Math.round(a.y),a.width,a.height):t&&"object"==typeof t&&(e._data=n,e._view=o,c?(u=a.width/t.w,_=a.height/t.h,o&&(g=o.getSizeZoom?o.getSizeZoom()*o.getGraphicsZoom():o.getZoom()),!i._cache||Math.max(u*g,_*g)>1?drawVector(e,t,r,a,n,o,l):e.drawImage(r?i.getImage(r):i._cache,Math.round(a.x),Math.round(a.y),a.width,a.height)):drawVector(e,t,r,a,n,o,l),e._data=null,e._view=null)},drawVector=function(e,t,r,a,n,o,l){var i,c,u,_,g,x,y,s,h,V,v,f,p,d,w,m,C,S=n&&n.getStyle("image.state");for(h=e._vector,m=e._color,V=e._fill,v=e._pattern,f=e._lineWidth,p=e._alpha,d=e._sx,w=e._sy,x=t,e._color=r,i=getVectorValue(n,x,x,"v",o),c=i&&i.length,y=a.width/x.w,s=a.height/x.h,l===!0?(e._fill=null,e._pattern=null,e._lineWidth=null,e._alpha=null):(e._sx=y,e._sy=s),e.save(),x.clip&&(e.rect(a.x,a.y,a.width,a.height),e.clip()),e.translate(a.x+a.width/2,a.y+a.height/2),(1!==y||1!==s)&&e.scale(y,s),x.origin&&e.translate((x.origin.x-.5)*x.w,(x.origin.y-.5)*x.h),setCanvasStyle(n,x,x,e,o),e._vector=x,u=0,c=i.length;u<c;u++)g=i[u],e._shapeData=g,g.animate&&refreshAnimate(g,x,n,o),C=getVectorValue(n,x,g,"state",o),getVectorValue(n,x,g,"visible",o)===!1||C&&!(Array.isArray(C)?C.indexOf(S)>=0:C===S)||(_=shapeFunction[g.shape],_&&(e.save(),"vector"===g.shape?_(e,g,n,o):setCanvasStyle(n,x,g,e,o,function(){_(e,g,n,o)}),e.restore()));e.restore(),e._vector=h,e._shapeData=null,e._color=m,e._fill=V,e._pattern=v,e._lineWidth=f,e._alpha=p,e._sx=d,e._sy=w},fillPattern=function(e,t,r,a,n){var o,l,i,c,u,_,g,x,y,s=e._vector,h=s.origin;if("string"==typeof t?(y=_twaver.images[t],y&&(i=y.getWidth(),c=y.getHeight())):(i=t.w,c=t.h),i&&c&&r)for(u=r.w/i*e._sx,_=r.h/c*e._sy,o=r.x-s.w/2*(e._sx-1),l=r.y-s.h/2*(e._sy-1),h&&(o-=(h.x-.5)*s.w*(e._sx-1),l-=(h.y-.5)*s.h*(e._sy-1)),1===e._sx&&1===e._sy||(e.scale(1/e._sx,1/e._sy),o+=((h?h.x:.5)*s.w+r.x)*(e._sx-1),l+=((h?h.x:.5)*s.h+r.y)*(e._sy-1)),r={x:0,y:0,width:i,height:c},g=0;g<u;g++)for(x=0;x<_;x++)r.x=g*i+o,r.y=x*c+l,drawImage(e,t,null,r,a,n,!0)},shapeFunction={line:function(e,t,r,a){var n,o,l,i,c=getVectorValue(r,e._vector,t,"p1",a),u=getVectorValue(r,e._vector,t,"p2",a);c?(n=getHStringValue(c.x,e),o=getVStringValue(c.y,e)):(n=getVectorValue(r,e._vector,t,"x1",a,!0),o=getVectorValue(r,e._vector,t,"y1",a,!1)),u?(l=getHStringValue(u.x,e),i=getVStringValue(u.y,e)):(l=getVectorValue(r,e._vector,t,"x2",a,!0),i=getVectorValue(r,e._vector,t,"y2",a,!1)),e.moveTo(n,o),e.lineTo(l,i)},rect:function(e,t,r,a){var n,o,l,i,c=getVectorValue(r,e._vector,t,"rect",a),u=getVectorValue(r,e._vector,t,"r",a);c?(Array.isArray(c)?(n=c[0],o=c[1],l=c[2],i=c[3]):(n=c.x,o=c.y,l=c.w,i=c.h),n=getHStringValue(n,e),o=getVStringValue(o,e),l=getHStringValue(l,e),i=getVStringValue(i,e)):(n=getVectorValue(r,e._vector,t,"x",a,!0),o=getVectorValue(r,e._vector,t,"y",a,!1),l=getVectorValue(r,e._vector,t,"w",a,!0),i=getVectorValue(r,e._vector,t,"h",a,!1)),e.drawRoundRect(n,o,l,i,u),(e._gradientFunc||e._pattern)&&(e._rect={x:n,y:o,w:l,h:i})},circle:function(e,t,r,a){var n,o=getVectorValue(r,e._vector,t,"cx",a,!0),l=getVectorValue(r,e._vector,t,"cy",a,!1),i=getStringValue(getVectorValue(r,e._vector,t,"r",a),Math.min(e._vector.w,e._vector.h),t),c=getVectorValue(r,e._vector,t,"startAngle",a),u=getVectorValue(r,e._vector,t,"endAngle",a),_=getVectorValue(r,e._vector,t,"anticlockwise",a);null==c&&(c=0),null==u&&(u=360),null==_&&(_=!1),n=Math.abs(u-c)%360!==0,n&&e.moveTo(o,l),e.arc(o,l,i,c/180*Math.PI,u/180*Math.PI,_),n&&e.closePath(),(e._gradientFunc||e._pattern)&&(e._rect={x:o-i,y:l-i,w:2*i,h:2*i})},ellipse:function(e,t,r,a){var n=getVectorValue(r,e._vector,t,"cx",a,!0),o=getVectorValue(r,e._vector,t,"cy",a,!1),l=getVectorValue(r,e._vector,t,"rx",a,!0),i=getVectorValue(r,e._vector,t,"ry",a,!1);e.ellipse(n,o,l,i,0,0,2*Math.PI,!0),(e._gradientFunc||e._pattern)&&(e._rect={x:n-l,y:o-i,w:2*l,h:2*i})},path:function(e,t,r,a){var n=getVectorValue(r,e._vector,t,"data",a);e.drawPath(n)},text:function(e,t,r,a){var n=getVectorValue(r,e._vector,t,"text",a),o=getVectorValue(r,e._vector,t,"x",a,!0),l=getVectorValue(r,e._vector,t,"y",a,!1);n&&e.fillText(n,o,l)},draw:function(e,t,r,a){var n,o,l=t.draw;"string"==typeof l&&((n=l.match(bindingPattern_evaluate))?(o="with(data) { "+n[1]+" }",l=new Function("g","data","view",o)):l=drawFunctionCache[l]),"function"==typeof l&&l.call(e._vector,e,r,a)},vector:function(e,t,r,a){var n,o,l,i,c,u,_,g,x,y,s=e._vector,h=getVectorValue(r,s,t,"name",a),V=getVectorValue(r,s,t,"x",a,!0),v=getVectorValue(r,s,t,"y",a,!1),f=getVectorValue(r,s,t,"w",a),p=getVectorValue(r,s,t,"h",a);if("string"==typeof h?(g=_twaver.images[h],_=g&&g._image):_=h,_)if(isImage(_))null!=f&&null!=p?e.drawImage(_,V,v,getHStringValue(f,e),getVStringValue(p,e)):e.drawImage(_,V,v);else{for(x=getVectorValue(r,_,_,"v",a),y=x&&x.length,null!=f&&null!=p?(f=getHStringValue(f,e),p=getVStringValue(p,e)):(f=_.w,p=_.h),e.save(),i=e._lineWidth,c=e._fill,u=e._alpha,setCanvasStyle(r,_,_,e,a),setCanvasStyle(r,s,t,e,a),e.translate(V,v),e.scale(f/_.w,p/_.h),_.origin&&e.translate((_.origin.x-.5)*_.w,(_.origin.y-.5)*_.h),_.clip&&(e.beginPath(),e.rect(-f/2,-p/2,f,p),e.clip()),e._vector=_,n=0;n<y;n++)o=x[n],e._shapeData=o,o.animate&&refreshAnimate(o,s,r,a),getVectorValue(r,_,o,"visible",a)!==!1&&(l=shapeFunction[o.shape],l&&(e.save(),"vector"===o.shape?l(e,o,r,a):setCanvasStyle(r,_,o,e,a,function(){l(e,o,r,a)}),e.restore()));e._vector=s,e._shapeData=t,e._lineWidth=i,e._fill=c,e._alpha=u,e.restore()}}};shapeFunction.image=shapeFunction.vector;var nativeShapeKeys=Object.keys(shapeFunction),pathFunction={M:function(e,t){return e.moveTo(t.x,t.y,0),e._rect&&getMaxRect(e._rect,t.x,t.y),t},m:function(e,t,r){return r&&(t={x:r.x+t.x,y:r.y+t.y}),e.moveTo(t.x,t.y,0),e._rect&&getMaxRect(e._rect,t.x,t.y),t},Z:function(e){e.closePath()},z:function(e){e.closePath()},L:function(e,t){return e.lineTo(t.x,t.y,0),e._rect&&getMaxRect(e._rect,t.x,t.y),t},l:function(e,t,r){var a={x:r.x+t.x,y:r.y+t.y};return e.lineTo(a.x,a.y,0),e._rect&&getMaxRect(e._rect,a.x,a.y),a},H:function(e,t,r){var a={x:t.x,y:r.y};return e.lineTo(a.x,a.y,0),e._rect&&getMaxRect(e._rect,a.x,a.y),a},h:function(e,t,r){var a={x:r.x+t.x,y:r.y};return e.lineTo(a.x,a.y,0),e._rect&&getMaxRect(e._rect,a.x,a.y),a},V:function(e,t,r){var a={x:r.x,y:t.y};return e.lineTo(a.x,a.y,0),e._rect&&getMaxRect(e._rect,a.x,a.y),a},v:function(e,t,r){var a={x:r.x,y:r.y+t.y};return e.lineTo(a.x,a.y,0),e._rect&&getMaxRect(e._rect,a.x,a.y),a},Q:function(e,t){return e._preQ_x=t.x1,e._preQ_y=t.y1,e.quadraticCurveTo(t.x1,t.y1,0,t.x,t.y,0),e._rect&&(getMaxRect(e._rect,t.x1,t.y1),getMaxRect(e._rect,t.x,t.y)),t},q:function(e,t,r){var a={x:r.x+t.x,y:r.y+t.y},n={x:r.x+t.x1,y:r.y+t.y1};return e._preQ_x=n.x,e._preQ_y=n.y,e.quadraticCurveTo(n.x,n.y,0,a.x,a.y,0),e._rect&&(getMaxRect(e._rect,n.x,n.y),getMaxRect(e._rect,a.x,a.y)),a},T:function(e,t,r){var a=e._preQ_x=2*r.x-e._preQ_x,n=e._preQ_y=2*r.y-e._preQ_y;return e.quadraticCurveTo(a,n,0,t.x,t.y,0),e._rect&&(getMaxRect(e._rect,a,n),getMaxRect(e._rect,t.x,t.y)),t},t:function(e,t,r){var a={x:r.x+t.x,y:r.y+t.y},n=e._preQ_x=2*r.x-e._preQ_x,o=e._preQ_y=2*r.y-e._preQ_y;return e.quadraticCurveTo(n,o,0,a.x,a.y,0),e._rect&&(getMaxRect(e._rect,n,o),getMaxRect(e._rect,a.x,a.y)),a},C:function(e,t){return e._preC_x=t.x2,e._preC_y=t.y2,e.bezierCurveTo(t.x1,t.y1,0,t.x2,t.y2,0,t.x,t.y,0),e._rect&&(getMaxRect(e._rect,t.x1,t.y1),getMaxRect(e._rect,t.x2,t.y2),getMaxRect(e._rect,t.x,t.y)),t},c:function(e,t,r){var a={x:r.x+t.x,y:r.y+t.y},n={x:r.x+t.x1,y:r.y+t.y1},o={x:r.x+t.x2,y:r.y+t.y2};return e._preC_x=o.x,e._preC_y=o.y,e.bezierCurveTo(n.x,n.y,0,o.x,o.y,0,a.x,a.y,0),e._rect&&(getMaxRect(e._rect,n.x,n.y),getMaxRect(e._rect,o.x,o.y),getMaxRect(e._rect,a.x,a.y)),a},S:function(e,t,r){e._preC_x=t.x2,e._preC_y=t.y2;var a=2*r.x-t.x2,n=2*r.y-t.y2;return e.bezierCurveTo(a,n,0,t.x2,t.y2,0,t.x,t.y,0),e._rect&&(getMaxRect(e._rect,a,n),getMaxRect(e._rect,t.x2,t.y2),getMaxRect(e._rect,t.x,t.y)),t},s:function(e,t,r){var a={x:r.x+t.x,y:r.y+t.y},n=2*r.x-e._preC_x,o=2*r.y-e._preC_y,l={x:r.x+t.x2,y:r.y+t.y2};return e._preC_x=l.x,e._preC_y=l.y,e.bezierCurveTo(n,o,0,l.x,l.y,0,a.x,a.y,0),e._rect&&(getMaxRect(e._rect,n,o),getMaxRect(e._rect,l.x,l.y),getMaxRect(e._rect,a.x,a.y)),a}},setCanvasStyle=function(e,t,r,a,n,o){var l,i,c,u,_,g,x,y,s,h=getVectorValue(e,t,r,"line",n),V=getVectorValue(e,t,r,"fill",n),v=getVectorValue(e,t,r,"gradient",n),f=getVectorValue(e,t,r,"gradientColor",n),p=getVectorValue(e,t,r,"pattern",n),d=getVectorValue(e,t,r,"font",n),w=getVectorValue(e,t,r,"textAlign",n)||"center",m=getVectorValue(e,t,r,"textBaseline",n)||"middle",C=getVectorValue(e,t,r,"translate",n),S=getVectorValue(e,t,r,"rotate",n),M=getVectorValue(e,t,r,"scale",n),T=getVectorValue(e,t,r,"alpha",n),R=a._lineWidth,F=a._fill,b=a._pattern,P=a._alpha,I=a._gradientFunc;h?(l=h.color,i=h.width,c=h.cap,u=h.join,_=h.miterLimit,g=h.dash,x=h.dashOffset):(l=getVectorValue(e,t,r,"lineColor",n),i=getVectorValue(e,t,r,"lineWidth",n),c=getVectorValue(e,t,r,"lineCap",n),u=getVectorValue(e,t,r,"lineJoin",n),_=getVectorValue(e,t,r,"miterLimit",n),g=getVectorValue(e,t,r,"lineDash",n),x=getVectorValue(e,t,r,"lineDashOffset",n)),null!=l&&(a.strokeStyle=getFilterColor(l,a._color)),null!=i&&(a.lineWidth=a._lineWidth=n&&n.getSizeZoom?i/n.getSizeZoom():i),null!=c&&(a.lineCap=c),null!=u&&(a.lineJoin=u),null!=_&&(a.miterLimit=_),null!=g&&(a.lineDash=g,a.setLineDash(g)),null!=x&&(a.lineDashOffset=x),p?a._pattern=p:(V&&(a.fillStyle=a._fill=getFilterColor(V,a._color)),v&&("string"==typeof v?s=gradient_types[v]:(s=gradient_types[v.type],v.color&&(f=v.color),s||(v=parseGradient(v,a))),a._gradientFunc=s)),null!=d&&(a.font=d),null!=w&&(a.textAlign=w),null!=m&&(a.textBaseline=m),setCanvasShadowStyle(e,t,r,a,n),null!=C&&("object"==typeof C?0===C.x&&0===C.y||a.translate(C.x,C.y):0!==C&&a.translate(C,C)),null!=S&&S%360!==0&&a.rotate(S*Math.PI/180),null!=M&&("object"==typeof M?1===M.x&&1===M.y||a.scale(M.x,M.y):1!==M&&a.scale(M,M)),null!=T&&(a.globalAlpha=a._alpha=null!=P?P*T:T),o&&(a.beginPath(),o(),y=a._rect||r.rect,a._pattern?(a._lineWidth>0&&a.stroke(),a.clip(),fillPattern(a,a._pattern,y,e,n)):(s&&y&&(v=s(a,getFilterColor(V||"#000000",a._color),getFilterColor(f||"#FFFFFF",a._color),y.x,y.y,y.w,y.h)),v&&(a.fillStyle=a._fill=v),a._fill&&a.fill(),a._lineWidth>0&&a.stroke()),a._lineWidth=R,a._fill=F,a._pattern=b,a._alpha=P,a._gradientFunc=I,a._rect=null)},setCanvasShadowStyle=function(e,t,r,a,n){var o,l,i,c,u=getVectorValue(e,t,r,"shadow",n);u?(o=u.offsetX,l=u.offsetY,i=u.blur,c=u.color):(o=getVectorValue(e,t,r,"shadowOffsetX",n),l=getVectorValue(e,t,r,"shadowOffsetY",n),i=getVectorValue(e,t,r,"shadowBlur",n),c=getVectorValue(e,t,r,"shadowColor",n)),null!=o&&(a.shadowOffsetX=o),null!=l&&(a.shadowOffsetY=l),null!=i&&(a.shadowBlur=i),null!=c&&(a.shadowColor=c)},bindingPattern_interpolate=/<%=([\s\S]+?)%>/,bindingPattern_evaluate=/<%([\s\S]+?)%>/,matcher=new RegExp([bindingPattern_interpolate.source,bindingPattern_evaluate.source].join("|")),getVectorValue=function(e,t,r,a,n,o){var l,i,c,u=r[a],_=typeof u;if("string"===_&&(l=u.match(matcher))?(i="with(data) { "+(l[1]?"return "+l[1]:l[2])+" }",c=new Function("data","view",i),u=c.call(t,e,n)):"function"===_&&(u=u.call(t,e,n)),o===!0?(r.rel===!0||void 0===r.rel&&t.rel?u*=t.w:"string"==typeof u&&(u=parseInt(u)/100*t.w),u=u||0):o===!1&&(r.rel===!0||void 0===r.rel&&t.rel?u*=t.h:"string"==typeof u&&(u=parseInt(u)/100*t.h),u=u||0),r._animate){var g=r._animate,x=g[a];if(x){if(!Array.isArray(x))return getAnimateValue(x,u);for(var y=x.length-1;y>=0;y--){var s=x[y];if(s.stop||s.time>0)return getAnimateValue(s,u)}}}return u},getHStringValue=function(e,t){return e?t._shapeData.rel===!0||void 0===t._shapeData.rel&&t._vector.rel?e*t._vector.w:"string"==typeof e?parseInt(e)/100*t._vector.w:e:0},getVStringValue=function(e,t){return e?t._shapeData.rel===!0||void 0===t._shapeData.rel&&t._vector.rel?e*t._vector.h:"string"==typeof e?parseInt(e)/100*t._vector.h:e:0},getStringValue=function(e,t,r){return e?r.rel===!0||void 0===r.rel&&g._vector.rel?e*t:"string"==typeof e?parseInt(e)/100*t:e:0},context_proto=(window.CanvasRenderingContext2D||Canvas.Context2d).prototype;context_proto.drawShape=function(e){var t=this,r=t._vector,a=t._data,n=t._view,o=shapeFunction[e.shape];o&&(t.save(),"vector"===e.shape?o(t,e,a,n):setCanvasStyle(a,r,e,t,n,function(){o(t,e,a,n)}),t.restore())};var drawPath=function(e){var t,r,a,n,o,l,i,c,u,_,g,x,y=new mono.Path;if("string"==typeof e&&(e=parsePathOrPoints(e)),u=e?e.length:0,!(u<=1)){if(t=e&&e[0]&&e[0].c,t||(r=e&&e[0]&&null!=e[0].x,a="z"===e[u-1]||"Z"===e[u-1],a&&u--),t){for(n=0;n<u;n++)l=e[n],i=pathFunction[l.c],i&&(o=i(y,l,o));y._preC_x=null,y._preC_y=null,y._preQ_x=null,y._preQ_y=null}else if(r){for(c=e[0],g=getHStringValue(c.x,y),x=getVStringValue(c.y,y),y.moveTo(g,x),_&&getMaxRect(_,g,x),n=1;n<u;n++)c=e[n],g=getHStringValue(c.x,y),x=getVStringValue(c.y,y),y.lineTo(g,x),_&&getMaxRect(_,g,x);a&&y.closePath()}else{for(g=getHStringValue(e[0],y),x=getVStringValue(e[1],y),y.moveTo(g,x),_&&getMaxRect(_,g,x),n=2;n<u;n+=2)g=getHStringValue(e[n],y),x=getVStringValue(e[n+1],y),y.lineTo(g,x),_&&getMaxRect(_,g,x);a&&y.closePath()}return y}},getMaxRect=function(e,t,r){var a=Math.min(e.x,t),n=Math.max(e.x+e.w,t),o=Math.min(e.y,r),l=Math.max(e.y+e.h,r);e.x=a,e.y=o,e.w=n-a,e.h=l-o};context_proto._fillPath=function(e,t){var r=this;r.beginPath(),r.fillStyle=e,r.drawPath(t),r.fill()},context_proto._fillRect=function(e,t,r,a,n){var o=this;o.beginPath(),o.fillStyle=e,o.rect(t,r,a,n),o.fill()},context_proto.ellipse||(context_proto.ellipse=function(e,t,r,a){var n=this,o=.5522848,l=r*o,i=a*o,c=e+r,u=t+a,_=e-r,g=t-a;n.moveTo(_,t),n.bezierCurveTo(_,t-i,e-l,g,e,g),n.bezierCurveTo(e+l,g,c,t-i,c,t),n.bezierCurveTo(c,t+i,e+l,u,e,u),n.bezierCurveTo(e-l,u,_,t+i,_,t)}),context_proto.drawRoundRect=function(e,t,r,a,n){var o=this;if(!n)return void o.rect(e,t,r,a);var l,i,c,u;if(Array.isArray(n))if(1===n.length)l=i=c=u=n[0];else if(2===n.length)l=i=n[0],c=u=n[1];else{if(4!==n.length)return void o.rect(e,t,r,a);l=n[0],i=n[1],c=n[2],u=n[3]}else l=i=c=u=n;var _=e+r,g=t+a,x=r<a?2*r:2*a;l=l<x?l:x,i=i<x?i:x,c=c<x?c:x,u=u<x?u:x;var y=.292893218813453*u,s=.585786437626905*u;o.moveTo(_,g-u),o.quadraticCurveTo(_,g-s,_-y,g-y),o.quadraticCurveTo(_-s,g,_-u,g),y=.292893218813453*c,s=.585786437626905*c,o.lineTo(e+c,g),o.quadraticCurveTo(e+s,g,e+y,g-y),o.quadraticCurveTo(e,g-s,e,g-c),y=.292893218813453*l,s=.585786437626905*l,o.lineTo(e,t+l),o.quadraticCurveTo(e,t+s,e+y,t+y),o.quadraticCurveTo(e+s,t,e+l,t),y=.292893218813453*i,s=.585786437626905*i,o.lineTo(_-i,t),o.quadraticCurveTo(_-s,t,_-y,t+y),o.quadraticCurveTo(_,t+s,_,t+i),o.lineTo(_,g-u)};var isImage=function(e){return Canvas?e instanceof Canvas||e instanceof Image:e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement},drawFunctionCache={},getDraw=function(e){return drawFunctionCache[e]},registerDraw=function(e,t){"function"==typeof t&&(drawFunctionCache[e]=t)},getShape=function(e){return shapeFunction[e]},registerShape=function(e,t){"function"==typeof t&&nativeShapeKeys.indexOf(e)<0&&(shapeFunction[e]=t)};